% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/utils_imagem.R
\name{image_correction}
\alias{image_correction}
\title{Correct Image Colors using a Color Checker}
\usage{
image_correction(img, card_colors = NULL, known_colors = NULL, k_mat = NULL)
}
\arguments{
\item{img}{An \code{Image} object to be corrected.}

\item{card_colors}{A data frame of the \emph{observed} colors from the color
checker in the image. Typically the output from \code{get_card_colors()}.
Must contain 'R', 'G', and 'B' columns.}

\item{known_colors}{A data frame of the \emph{known} reference colors for the
color checker. Must have 'R', 'G', and 'B' columns and the same
number of rows as \code{card_colors}.}

\item{k_mat}{A pre-calculated 9x9 transformation matrix (\strong{K}). If provided,
\code{card_colors} and \code{known_colors} are ignored, and the correction
is applied directly. This allows reusing a calculated matrix for multiple
images taken in the same light conditions. Defaults to \code{NULL}.}
}
\value{
If both \code{card_colors} and \code{known_colors} are provided (or if \code{k_mat} is \code{NULL}
and the required color data frames are present), a list is returned:
\itemize{
\item \strong{img}: An \code{Image} object with the color correction applied,
maintaining the original dimensions and color mode (\code{'Color'}).
\item \strong{k}: The calculated 9x9 transformation matrix (\strong{K}).
}
If only \code{img} and a pre-calculated \code{k_mat} are provided, the function
returns only the corrected \code{Image} object.
}
\description{
Calibrates the color of an image using a set of known color references (e.g.,
from a color checker) by implementing a 3rd-order polynomial color
correction. It works by finding a 9x9 transformation matrix (K) that maps the
observed colors (sampled from the color card) to their known reference values.
This matrix K is then applied to every pixel in the image.

The correction model is based on solving the equation \code{S * K = T}, where:
\itemize{
\item \code{S} is the polynomial matrix (9 terms) of the \emph{source} (sampled) colors.
\item \code{T} is the polynomial matrix (9 terms) of the \emph{target} (known) colors.
\item \code{K} is the 9x9 transformation matrix solved using the
Moore-Penrose pseudo-inverse.
}
}
\examples{
if(interactive(){
library(pliman)
img <- image_pliman("colorcheck.jpg")

kvals <- data.frame(
 id = 1:24,
 R = c(0.976471, 0, 0.870588, 0.384314, 0.792157, 0.752941, 0.227451,
 0.494118, 0.631373, 0.960784, 0.764706, 0.321569, 0.478431, 0.729412,
 0.32549, 0.341176, 0.313725, 0.223529, 0.615686, 0.772549, 0.168627,
 0.098033, 0.933333, 0.439216),
 G = c(0.94902, 0.498039, 0.462745, 0.733333,
 0.776471, 0.294118, 0.345098, 0.490196, 0.615686, 0.803922, 0.309804,
 0.415686, 0.462745, 0.101961, 0.227451, 0.470588, 0.313725, 0.572549,
 0.737255, 0.568627, 0.160784, 0.215686, 0.619608, 0.298039),
  B = c(0.933333,
 0.623529, 0.12549, 0.65098, 0.764706, 0.568627, 0.623529, 0.682353, 0.60392,
 0, 0.372549, 0.235294, 0.454902, 0.2, 0.415686, 0.607843, 0.305882, 0.25098,
 0.211765, 0.490196, 0.168627, 0.529412, 0.098039, 0.235294)
 )


card_colors <- get_card_colors(img, xpix = 20, ypix = 30, erode = 20)
corrected <- image_correction(img, card_colors, kvals)
image_combine(img, corrected$img)
}
}
